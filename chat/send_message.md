# ارسال پیام در چت

برنامه‌‌های کنار دیوار می‌توانند پس از [کسب اجازه از کاربر][احراز باز]، در یک چت یا چت‌های یک آگهی پیام ارسال کنند.
پیام‌های ارسالی از طرف کاربری که دسترسی به برنامه را داده و درخواست از سمتش بوده در چت ارسال می‌شود و هر دو طرف چت یک متن پیام می‌بینند، اما امکان درج دکمهٔ متفاوت برای طرفین چت وجود دارد.\
به علاوه در قسمت بالای پیام، عنوان برنامهٔ مورد نظر نشان داده می‌شود.

| ![نمایی از یک پیام ارسال شده توسط بات](/img/bot-message.png) |
| :----------------------------------------------------------: |
|   <sub dir="rtl">نمایی از یک پیام ارسال شده توسط بات</sub>   |

> ⭐️ بهتر است پیامی که در چت ارسال می‌کنید برای هر دو طرف معنادار باشد و اطلاعات مفید در راستای خدمت دریافت شده ارائه دهد.

> 🛑 برای مقاصد تبلیغاتی یا معرفی امکانات و خدماتتان پیام ارسال نکنید.

## دسترسی ارسال پیام در چت

برای اینکه بتوانید در یک چت پیامی ارسال کنید، نیاز است تا اجازهٔ دسترسی در دو نقطه فراهم شده‌باشد:\
۱. برنامهٔ شما به صورت کلی دسترسی لازم را در [پنل کنار دیوار][پنل کنار] گرفته‌باشد.\
۲. [از کاربر اجازه گرفته‌باشید][احراز باز] و `access_token` ارسالی در درخواستتان این اجازه را داشته‌باشد:
- SCOPE: CHAT_MESSAGE_SEND
- IDENTIFIER: BASE64(user_id:post_token:peer_id)

دو نوع دسترسی برای ارسال پیام در چت وجود دارد که برای هر کدام می‌توان جداگانه از کاربر اجازه گرفت. ارسال پیام در **یک چت** و ارسال پیام در **چت‌های یک آگهی**
جزییات و پارامترهای لازم برای درخواست دسترسی و ایجاد `access_token` را در [صفحهٔ احراز باز][احراز باز] ببینید.

## درخواست ارسال پیام در چت

در صورتی که اجازهٔ این درخواست رو طبق توضیحات بالا و [صفحهٔ احراز باز][احراز باز] داشته‌باشید، با ارسال درخواستی مشابه نمونهٔ زیر می‌توانید در چت مورد نظرتان پیام وارد کنید.

می‌توانید قسمت‌های فارسی را با مقادیر خودتان جایگزین کنید:

```http request
POST https://api.divar.ir/v2/open-platform/chat/conversation
Content-Type: application/json
x-api-key: {{apikey}}
x-access-token: {{access_token}}

{
    "user_id": "شناسهٔ کاربر فرستنده که می خواهیم پیامی از سمت او وارد چت کنیم",
    "post_token": "توکن آگهی مورد چت",
    "peer_id": "شناسهٔ کاربر گیرنده در چت",
    "type": "TEXT",
    "message": "متن پیام",
    "sender_btn": {
        "action": "LINK",
        "data": {
            "icon_name": "نام آیکون مورد نظر برای این دکمه",
            "extra_data": {
                "your_custom_key":"اطلاعاتی که در ادامه هنگام کلیک روی دکمه نیاز داریم"
            },
            "caption": "متن دکمهٔ زیر پیام برای طرف فرستنده"
        }
        این دکمه فقط برای کاربر فرستنده نمایش داده می‌شود
    },
    "receiver_btn": {
        "action": "LINK",
        "data": {
            "icon_name": "نام آیکون مورد نظر برای این دکمه",
            "extra_data": {
                "your_custom_key":"اطلاعاتی که در ادامه هنگام کلیک روی دکمه نیاز داریم"
            },
            "caption": "متن دکمهٔ زیر پیام برای طرف گیرنده"
        }
        این دکمه فقط برای کاربر فرستنده نمایش داده می‌شود
    }
}
```

در درخواست بالا، کاربران با [زدن روی دکمهٔ پیام][بازشدن برنامه]، در قالب webview یا pop-up به برنامهٔ شما وارد می‌شوند، در صورتی که نیاز به باز کردن صفحهٔ خود به صورت مستقیم در مرورگر دارید، می‌توانید ویژگی‌های دکمه را به شکل زیر تغییر دهید.

```
{
    "sender_btn": {
        "action": "DIRECT_LINK",
        "data": {
            "icon_name": "نام آیکون مورد نظر برای این دکمه",
            "direct_link": "آدرس صفحهٔ مورد نظر برای باز شدن هنگام کلیک",
            "caption": "متن دکمهٔ زیر پیام برای طرف فرستنده"
        }
    }
}
```

## دسترسی ارسال پیام در تمام مکالمات یک آگهی (آزمایشی)

دسترسی قبلی تنها مربوط به یک مکالمه می‌باشد، اما با داشتن این دسترسی می‌توانید در تمام مکالمات مربوط به یک آگهی از طرف آگهی گذار پیام بفرستید:
- SCOPE: CHAT_POST_CONVERSATIONS_MESSAGE_SEND
- IDENTIFIER: POST_TOKEN

## کلیک کاربر روی دکمهٔ درج شده زیر پیام

در صورتی که کاربر روی دکمه‌ای که زیر پیام اضافه کرده‌اید کلیک کند، ابتدا دیوار یک درخواست به آدرسی که در ابتدا تنظیم کرده‌اید می‌زند. [توضیحات بیشتر](/management#session-initialization-url/)

به همراه این درخواست موارد زیر ارسال خواهند شد و سپس کاربر به آدرسی که در دکمهٔ مورد نظر درج شده‌است هدایت می‌شود.

نمونهٔ محتوای ارسالی درخواست از سمت دیوار

```JSON
{
    "extra_data": {
        "provider_data": {"your_custom_key":"اطلاعاتی که در درخواست ارسال پیام در مرحلهٔ قبل فرستادید"},
    },
    "callback_url": "آدرسی که کاربر پس از انجام فرایند در سرویس شما باید به آن هدایت شود",
    "post_token":   "توکن آگهی",
    "user_id":      "شناسهٔ کسی که روی لینک کلیک کرده یا فرایند را شروع کرده",
    "peer_id":      "شناسهٔ طرف مقابل چت",
    "supplier": {
        "id": "شناسهٔ کاربر فروشنده (صاحب آگهی)"
    },
    "demand": {
        "id": "شناسهٔ کاربر خریدار"
    },
}

```

در پاسخ به این درخواست، می‌بایست آدرسی را به شکل زیر برگردانید. کاربر به أدرسی که در قسمت `url` پاسخ شماست هدایت می‌شود و با برنامهٔ تحت وب شما تعامل می‌کند.

```JSON
{
  "status": "200",
  "message": "success",
  "url": "https://yourdomain.com/some/where/to/start"
}
```

<br>

[احراز باز]: /oauth
[API key]: /management/api-keys.md
[پنل کنار]: /management
[ارسال پیام در یک چت]: #ارسال-پیام-در-یک-چت
[ارسال پیام در چت‌های آگهی]: #ارسال-پیام-در-چتهای-یک-آگهی
[بازشدن برنامه]: #کلیک-کاربر-روی-دکمهٔ-درج-شده-زیر-پیام

<br><br>

<div align="center">

<img src="/img/wire-puzzle.svg" height="156px"/>

</div>

<br><br>
