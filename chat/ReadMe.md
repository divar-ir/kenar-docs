# 💬 افزونه‌های چت دیوار

## نمایش شما به عنوان خدمت‌دهنده به کاربران

در چت دیوار به طرفین چت بر اساس مواردی مثل شهر یا دسته‌ٔ آگهی خدماتی را پیشنهاد می‌دهیم که اگر برنامهٔ شما در آن گروه برنامه‌ها باشد به عنوان خدمت‌دهنده به کاربران معرفی می‌شود.
مثلاً شما می‌توانید به عنوان خدمت‌دهنده در افزونه‌های ارسال کالا در چت به کاربران معرفی شوید تا با بازکردن برنامهٔ وب شما، درخواست خود را ثبت کنند.

|              ![مسیر ارائهٔ خدمات در چت](/img/chat-flow.png)               |
| :-----------------------------------------------------------------------: |
| <sub dir="rtl">مسیری که کاربر برای دریافت خدمات شما در چت طی می کند</sub> |


## بازشدن برنامه توسط کاربر

۱. در هر زمانی که چت دیوار بخواهد برنامهٔ شما را باز کند، درخواستی با جزییات زیر به آدرسی که در فیلد ‍`Session Initialization URL` [در پنل کنار وارد کرده‌اید](/management/#لیست-پارامترها) ارسال می‌کند و در صورت دریافت پاسخ معتبر، کاربر را به آدرسی که در پاسخ وجود دارد هدایت می‌کند.

```http
POST https://your.app.ir
Content-Type: application/json
authorization: {{ Divar Identification Key }}

{
    "extra_data": {
      "location": {
        "latitude": "اگر برنامهٔ شما از مسیر دکمه‌هایی که چت دیوار زیر پیام‌های از نوع موقعیت مکانی درج می‌کند، باز شود، این اطلاعات هم در درخواست ارسالی از سمت دیوار خواهید داشت.",
        "longitude": "51.34850978851319"
      }
    },
    "callback_url": "آدرسی که کاربر پس از انجام فرایند در سرویس شما باید به آن هدایت شود",
    "post_token": "توکن آگهی",
    "conversation_id": "813d3106-dcb8-4283-b2a3-29e8edcc4dbc",
    "user_id": "شناسهٔ کسی که روی لینک کلیک کرده یا فرایند را شروع کرده",
    "peer_id": "شناسهٔ طرف مقابل چت",
    "supplier": {
      "id": "شناسهٔ کاربر فروشنده (صاحب آگهی)"
    },
    "demand": {
      "id": "شناسهٔ کاربر خریدار"
    },
}

```

- پارامتر `post_token` شناسهٔ آگهی‌ مورد نظر است.
- پارامتر `conversation_id` شناسه‌ی مکالمه‌ای است که کاربر از آن به سمت اپ شما هدایت شده است.
- پارامتر `user_id` شناسهٔ کاربریست که با اپلیکیشن تعامل کرده.
- پارامتر `peer_id` شناسهٔ طرف دیگر چت است.
- برای [دریافت اجازه‌ها][راهنما » احراز باز] یا [استفاده از امکانات مربوط به چت][امکانات چت]، هر سهٔ این پارامترها را ارائه کنید.
- پارامتر `callback_url` ادرسی‌ست که باید کاربر را بعد از اتمام فرآیند به آن هدایت کنید.
- مقدار `authorization` معادل پارامتر `Divar Identification Key`، که در سطح اپلیکیشن قابل تنظیم است، قرار داده خواهد شد. با خواندن این هدر و مقایسهٔ آن، می‌توانید منبع درخواست را احراز کرده مطمئن شوید درخواست از جانب دیوار ارسال شده است.

<br>

در پاسخ به این درخواست، می‌بایست آدرسی را به شکل زیر برگردانید. کاربر به أدرسی که در قسمت `url` پاسخ شماست هدایت می‌شود و با برنامهٔ تحت وب شما تعامل می‌کند.

```JSON
{
  "status": "200",
  "message": "success",
  "url": "https://yourdomain.com/some/where/to/start"
}
```

<br>

## ارائهٔ خدمات در برنامهٔ تحت وب شما و بازگشت به دیوار

پس از باز شدن برنامهٔ شما در اپ دیوار به صورت webview در اپلیکیشن‌های دیوار یا pop-up در وب دیوار، کاربر عملیات مورد نظر شما را در برنامهٔ شما طی می‌کند و خدمات مورد نظر را دریافت می‌کند. پس از اتمام کار برنامه می‌بایست کاربر را به دیوار برگرداند.\
پیشنهاد می‌کنیم در زمان‌هایی که دانستن نتیجهٔ کار برای هر دو طرف چت لازم است، [نتیجه را در چت اعلام کنید][چت»ارسال پیام] و دکمه‌ای برای پیگیری نیز در پیام درج کنید.

برای ارسال پیام در چت باید در برنامهٔ خود از طریق [احراز باز](/oauth/) اجازهٔ ارسال پیام در چت را از کاربر گرفته‌باشید. \
همچنین ممکن است نیاز به دریافت دسترسی برای ارسال پیام در چت یا موارد دیگر از کاربر شوید که می‌توانید با استفاده از [احراز باز](/oauth/) در موردشان از کاربر اجازه بگیرید.


## خواندن و ارسال پیام در تمام مکالمات مربوط به یک آگهی (آزمایشی)

برای خواندن پیام‌های چت به صورت لحظه‌ای می‌توانید از مستندات [مطلع شدن از رویداد‌های جدید](/events/ReadMe.md) استفاده کنید.

 همچنین برای ارسال پیام می‌توانید به مستندات [ارسال پیام در چت][چت»ارسال پیام] مراجعه کنید.


## مکالمه با کاربر به شکل چت‌بات (آزمایشی)

به منظور ایجاد و فعال‌سازی چت‌بات می‌توانید به پشتیبانی کنار دیوار تیکت بزنید و درخواست خود را مطرح کنید تا زیرساخت آن در دسترس شما قرار بگیرد.

در صورت برخوردار شدن از این امکان توسط پشتیبانی، با پر کردن مقدار `آدرس ارسال رویدادها` در پنل کنار، پیام‌های ارسالی به چت‌بات خود را دریافت خواهید کرد. برای اطلاعات بیشتر و فرمت درخواست‌های ارسالی می‌توانید [اینجا][راهنما » چت‌بات] را مطالعه کنید.

همچنین می‌توانید به کاربرانی که به چت‌بات شما پیام داده‌اند، پیام بفرستید. برای اطلاعات بیشتر [اینجا][راهنما » چت‌بات] را مطالعه کنید.
<br>
مثال چت: پیاده‌سازی
[بازی ایکس او](https://github.com/amirsalarsafaei/kenar-xo/tree/master)
با کنار دیوار


## دسترسی سریع

- [🔑 دریافت دسترسی‌ها از کاربر](/oauth/)
- [↗️ ارسال پیام در چت کاربر][چت»ارسال پیام]
- [↗️ ارسال پیام در چت بات][راهنما » چت‌بات]


[آگهی]: /management/#تعامل-با-کاربر-پس-از-ثبت-آگهی
[راهنما » احراز باز]: /oauth
[امکانات چت]: /chat/#دسترسی-سریع
[راهنما » چت‌بات]: /chat/chatbot_conversations.md
[چت»ارسال پیام]: /chat/user_conversations.md

<br><br>

<div align="center">

<img src="../img/wire-puzzle.svg" height="156px"/>

</div>

<br><br>
